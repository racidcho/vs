# 커플 관리 웹앱 테스트 보고서
**테스트 일시**: 2025년 8월 10일  
**테스트 환경**: Production (https://joanddo.com)  
**테스터**: 라시드

## 📋 테스트 개요

데이터베이스 초기화 후 전체 시스템 기능 테스트를 진행했습니다. 두 개의 계정을 사용하여 커플 생성, 연결, CRUD 작업 및 실시간 동기화를 검증했습니다.

### 테스트 계정
- **계정 1**: racidcho@naver.com (라시드)
- **계정 2**: racidcho@gmail.com (도기)
- **커플 코드**: QX3U5N

## ✅ 성공적으로 완료된 기능

### 1. 커플 생성 및 연결
- ✅ 첫 번째 사용자(라시드)로 커플 생성 성공
- ✅ 커플 코드 생성 및 표시 정상 (QX3U5N)
- ✅ 두 번째 사용자(도기)로 커플 참여 성공
- ✅ 양쪽 계정에서 파트너 이름 정상 표시

### 2. 축하 페이지
- ✅ 커플 연결 완료 후 축하 페이지 표시
- ✅ "우리들의 벌금통 시작하기" 버튼으로 홈 이동
- ⚠️ 부분 수정: 두 번째 로그인 시 중복 표시 버그 수정 (배포 완료)

### 3. CRUD 기능

#### 규칙 생성
- ✅ 도기 계정: "늦게 일어나기" (벌금: 5만원)
- ✅ 라시드 계정: "청소 안하기" (벌금: 3만원)
- ✅ 실시간 동기화 확인

#### 보상 생성
- ✅ 도기 계정: "영화 보러 가기" (목표 금액: 20만원)
- ✅ 실시간 동기화 확인

### 4. 실시간 동기화
- ✅ 규칙이 양쪽 계정에서 즉시 동기화
- ✅ 보상이 양쪽 계정에서 즉시 동기화
- ✅ Realtime 구독 정상 작동

## ❌ 발견된 문제점

### 1. Foreign Key 스키마 캐시 에러
**에러 메시지**: 
```
Could not find a relationship between 'couples' and 'profiles' in the schema cache
```
**영향**: 
- 페이지 새로고침 시 무한 로딩
- 커플 데이터 로드 실패

**시도한 해결책**:
- 모든 Foreign Key 제약조건 제거
- JOIN 쿼리를 단순 SELECT로 변경
- 별도 쿼리로 데이터 분리

**현재 상태**: 부분적 해결, 일부 상황에서 여전히 발생

### 2. 벌금 통계 미표시 (Versus 위젯)
**문제**: 
- 벌금을 기록해도 "우리의 대결" 섹션에서 0만원으로 표시
- 총 벌금과 총 기록 수도 0으로 표시

**원인 추정**:
- `violator_user_id` 필드 매핑 문제
- violations 데이터 로드 또는 필터링 로직 오류

**현재 상태**: 미해결

### 3. 벌금 기록 페이지 로딩 문제
**문제**: 
- `/violations/new` 페이지 무한 로딩
- "No couple_id, skipping legacy subscriptions" 반복 로그

**원인**: 
- 커플 데이터 로드 실패로 인한 연쇄 오류

**현재 상태**: 미해결

## 🔧 수정 및 배포 내역

### 1. Dashboard.tsx 수정
- **커밋**: `fix: 축하 페이지 중복 표시 버그 수정 - localStorage 키 일관성 확보`
- **변경 내용**: 
  - sessionStorage 체크 로직 제거
  - localStorage만 사용하여 중복 방지
  - 불필요한 location.search 제거

## 📊 테스트 결과 요약

| 기능 | 상태 | 비고 |
|------|------|------|
| 커플 생성 | ✅ 성공 | |
| 커플 연결 | ✅ 성공 | 커플 코드: QX3U5N |
| 축하 페이지 | ⚠️ 부분 성공 | 중복 표시 버그 수정됨 |
| 규칙 CRUD | ✅ 성공 | 2개 규칙 생성 및 동기화 |
| 보상 CRUD | ✅ 성공 | 1개 보상 생성 및 동기화 |
| 벌금 기록 | ❌ 실패 | 기록은 되나 통계 미표시 |
| 실시간 동기화 | ✅ 성공 | |
| Versus 위젯 | ❌ 실패 | 금액 0원으로 표시 |

## 🎯 다음 단계 권장사항

### 긴급 수정 필요
1. **Foreign Key 에러 완전 제거**
   - AppContext.tsx의 모든 JOIN 쿼리 점검
   - 테스트 데이터 생성 로직 검토
   
2. **Versus 위젯 벌금 표시 수정**
   - violations 테이블 스키마 확인
   - violator_user_id 필드 매핑 검증
   - 필터링 로직 수정

3. **벌금 기록 페이지 로딩 문제**
   - 커플 데이터 로드 로직 개선
   - 에러 핸들링 강화

### 개선 제안
1. 에러 복구 메커니즘 추가
2. 로딩 타임아웃 설정
3. 사용자 친화적 에러 메시지
4. 디버그 모드 강화

## 📝 테스트 환경 설정

### 테스트 요구사항
- 항상 Production 환경에서 테스트 (https://joanddo.com)
- 테스트 모드 사용 (OTP 우회)
- 실제 데이터로 테스트 (목 데이터 사용 안 함)
- 변경사항 즉시 배포 (git push)
- 콘솔 디버깅 우선 (스크린샷 대신)

### 테스트 데이터
- 규칙 1: "늦게 일어나기" (5만원)
- 규칙 2: "청소 안하기" (3만원)  
- 보상 1: "영화 보러 가기" (목표: 20만원)
- 벌금 기록: 2건 시도 (통계 미반영)

## 🔍 디버그 로그 주요 내용

### 정상 로그
```
✅ APPCONTEXT: 파트너 정보 반환
🔗 APPCONTEXT REALTIME: Setting up legacy subscriptions
🔌 APPCONTEXT REALTIME [COUPLES]: Channel status: SUBSCRIBED
```

### 에러 로그
```
💥 APPCONTEXT: 커플 데이터 로드 실패: PGRST200
🚫 APPCONTEXT REALTIME: No couple_id, skipping legacy subscriptions
❌ OTP verification failed: Token has expired or is invalid
```

---

**작성일**: 2025년 8월 10일  
**작성자**: Assistant (Claude)  
**검토자**: 라시드