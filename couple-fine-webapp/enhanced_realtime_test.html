<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ Enhanced Realtime í…ŒìŠ¤íŠ¸ - joanddo.com</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            background: linear-gradient(135deg, #fdf2f8 0%, #f3e8ff 100%);
            color: #1f2937;
        }
        .header { 
            background: linear-gradient(135deg, #ec4899, #8b5cf6);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        .section { 
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .connected { 
            background: #dcfce7;
            border: 1px solid #16a34a;
            color: #15803d;
        }
        .disconnected { 
            background: #fecaca;
            border: 1px solid #dc2626;
            color: #b91c1c;
        }
        button { 
            background: linear-gradient(135deg, #ec4899, #8b5cf6);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
        }
        button:hover { 
            opacity: 0.8;
        }
        .log {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 5px;
            border-left: 3px solid #3b82f6;
            background: white;
        }
        .log-success { border-left-color: #10b981; }
        .log-error { border-left-color: #ef4444; }
        .log-warn { border-left-color: #f59e0b; }
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        input, select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>âš¡ Enhanced Realtime í…ŒìŠ¤íŠ¸</h1>
        <p>ì¦‰ì‹œ ì‘ë™í•˜ëŠ” Supabase Realtime Channels êµ¬í˜„</p>
        <div id="main-status" class="status disconnected">ğŸ”´ ì—°ê²° ì¤€ë¹„ ì¤‘...</div>
    </div>

    <div class="section">
        <h2>ğŸ”Œ ì—°ê²° ì„¤ì •</h2>
        <div class="input-group">
            <label>Couple ID:</label>
            <input type="text" id="couple-id" placeholder="your-couple-id" value="">
            <button onclick="initializeRealtime()">ğŸš€ ì—°ê²° ì‹œì‘</button>
        </div>
        <div class="input-group">
            <label>ì‚¬ìš©ì ì´ë©”ì¼:</label>
            <input type="email" id="user-email" placeholder="user@example.com">
            <button onclick="setCurrentUser()">ğŸ‘¤ ì‚¬ìš©ì ì„¤ì •</button>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ§ª í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥</h2>
        <div class="grid">
            <div>
                <h3>ğŸ“‹ ê·œì¹™ í…ŒìŠ¤íŠ¸</h3>
                <div class="input-group">
                    <input type="text" id="rule-title" placeholder="ê·œì¹™ ì œëª©">
                    <input type="number" id="rule-amount" placeholder="ë²Œê¸ˆ">
                </div>
                <button onclick="testCreateRule()">â• ê·œì¹™ ìƒì„±</button>
                <button onclick="testUpdateRule()">âœï¸ ê·œì¹™ ìˆ˜ì •</button>
                <button onclick="testDeleteRule()">ğŸ—‘ï¸ ê·œì¹™ ì‚­ì œ</button>
            </div>

            <div>
                <h3>âš–ï¸ ìœ„ë°˜ í…ŒìŠ¤íŠ¸</h3>
                <div class="input-group">
                    <input type="number" id="violation-amount" placeholder="ë²Œê¸ˆì•¡">
                    <input type="text" id="violation-memo" placeholder="ë©”ëª¨">
                </div>
                <button onclick="testCreateViolation()">â• ìœ„ë°˜ ê¸°ë¡</button>
            </div>

            <div>
                <h3>ğŸ ë³´ìƒ í…ŒìŠ¤íŠ¸</h3>
                <div class="input-group">
                    <input type="text" id="reward-title" placeholder="ë³´ìƒ ì œëª©">
                    <input type="number" id="reward-target" placeholder="ëª©í‘œ ê¸ˆì•¡">
                </div>
                <button onclick="testCreateReward()">â• ë³´ìƒ ìƒì„±</button>
                <button onclick="testClaimReward()">ğŸ† ë³´ìƒ ë‹¬ì„±</button>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ“Š ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</h2>
        <div class="input-group">
            <button onclick="clearLog()">ğŸ§¹ ë¡œê·¸ ì§€ìš°ê¸°</button>
            <button onclick="testBroadcast()">ğŸ“¤ í…ŒìŠ¤íŠ¸ ë¸Œë¡œë“œìºìŠ¤íŠ¸</button>
            <button onclick="checkConnection()">ğŸ” ì—°ê²° ìƒíƒœ í™•ì¸</button>
        </div>
        <div id="realtime-log" class="log"></div>
    </div>

    <script>
        // Supabase ì´ˆê¸°í™”
        const { createClient } = supabase;
        
        // âš ï¸ ì‹¤ì œ í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©
        const supabaseUrl = 'https://ywocrwjzjheupewfxssu.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl3b2Nyd2pqaGV1cGV3Znhzc3UiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTcyMzI4MDk0NSwiZXhwIjoyMDM4ODU2OTQ1fQ.eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl3b2Nyd2pqaGV1cGV3Znhzc3UiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTcyMzI4MDk0NSwiZXhwIjoyMDM4ODU2OTQ1fQ.eT9U';
        
        window.supabase = createClient(supabaseUrl, supabaseAnonKey);
        
        let realtimeManager = null;
        let enhancedCRUD = null;
        let lastRuleId = null;
        let lastRewardId = null;

        // ë¡œê·¸ í•¨ìˆ˜
        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('realtime-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>${timestamp}</strong> ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('realtime-log').innerHTML = '';
        }

        function updateMainStatus(connected) {
            const statusEl = document.getElementById('main-status');
            if (connected) {
                statusEl.textContent = 'ğŸŸ¢ Enhanced Realtime ì—°ê²°ë¨';
                statusEl.className = 'status connected';
            } else {
                statusEl.textContent = 'ğŸ”´ ì—°ê²° ëŠê¹€ ë˜ëŠ” ì¤€ë¹„ ì¤‘';
                statusEl.className = 'status disconnected';
            }
        }

        // Realtime ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ë° ì´ˆê¸°í™”
        function loadRealtimeScript() {
            return new Promise((resolve, reject) => {
                if (window.CoupleRealtimeManager) {
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = '/realtime_alternative_implementation.js';
                script.onload = () => {
                    addLog('ğŸ“¦ Realtime script loaded successfully', 'success');
                    resolve();
                };
                script.onerror = () => {
                    addLog('âŒ Failed to load Realtime script', 'error');
                    reject(new Error('Script load failed'));
                };
                document.head.appendChild(script);
            });
        }

        // ì‚¬ìš©ì ì„¤ì •
        async function setCurrentUser() {
            const email = document.getElementById('user-email').value;
            if (!email) {
                addLog('âš ï¸ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warn');
                return;
            }

            try {
                // ê°„ë‹¨í•œ ì¸ì¦ ì‹œë®¬ë ˆì´ì…˜
                addLog(`ğŸ‘¤ ì‚¬ìš©ì ì„¤ì •: ${email}`, 'success');
            } catch (error) {
                addLog(`âŒ ì‚¬ìš©ì ì„¤ì • ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // Enhanced Realtime ì´ˆê¸°í™”
        async function initializeRealtime() {
            const coupleId = document.getElementById('couple-id').value;
            if (!coupleId) {
                addLog('âš ï¸ Couple IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warn');
                return;
            }

            try {
                addLog('ğŸš€ Enhanced Realtime ì´ˆê¸°í™” ì‹œì‘...', 'info');
                
                // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
                await loadRealtimeScript();
                
                // Realtime Manager ì´ˆê¸°í™”
                realtimeManager = new window.CoupleRealtimeManager();
                await realtimeManager.getCurrentUser();
                
                // Broadcast Channel ì„¤ì •
                realtimeManager.setupBroadcastChannel(coupleId);
                
                // Enhanced CRUD ì´ˆê¸°í™”
                enhancedCRUD = new window.EnhancedCRUD(realtimeManager);
                
                addLog(`âœ… Enhanced Realtime ì´ˆê¸°í™” ì™„ë£Œ: ${coupleId}`, 'success');
                
                // ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
                setInterval(() => {
                    updateMainStatus(realtimeManager.isConnected);
                }, 2000);
                
            } catch (error) {
                addLog(`âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
        async function testCreateRule() {
            if (!enhancedCRUD) {
                addLog('âš ï¸ ë¨¼ì € Realtimeì„ ì´ˆê¸°í™”í•´ì£¼ì„¸ìš”', 'warn');
                return;
            }

            const title = document.getElementById('rule-title').value || 'í…ŒìŠ¤íŠ¸ ê·œì¹™';
            const amount = parseInt(document.getElementById('rule-amount').value) || 5000;

            try {
                addLog(`ğŸ“‹ ê·œì¹™ ìƒì„± ì‹œë„: ${title} (${amount}ì›)`, 'info');
                
                const ruleData = {
                    title,
                    description: 'í…ŒìŠ¤íŠ¸ìš© ê·œì¹™ì…ë‹ˆë‹¤',
                    amount,
                    category: 'general',
                    couple_id: document.getElementById('couple-id').value,
                    created_by_user_id: 'test-user-id',
                    is_active: true
                };

                const result = await enhancedCRUD.createRule(ruleData);
                lastRuleId = result.id;
                
                addLog(`âœ… ê·œì¹™ ìƒì„± ì™„ë£Œ: ${result.id}`, 'success');
            } catch (error) {
                addLog(`âŒ ê·œì¹™ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function testUpdateRule() {
            if (!enhancedCRUD || !lastRuleId) {
                addLog('âš ï¸ ë¨¼ì € ê·œì¹™ì„ ìƒì„±í•´ì£¼ì„¸ìš”', 'warn');
                return;
            }

            try {
                const updates = {
                    title: 'ìˆ˜ì •ëœ í…ŒìŠ¤íŠ¸ ê·œì¹™',
                    amount: 7000
                };

                addLog(`ğŸ“‹ ê·œì¹™ ìˆ˜ì • ì‹œë„: ${lastRuleId}`, 'info');
                const result = await enhancedCRUD.updateRule(lastRuleId, updates);
                addLog(`âœ… ê·œì¹™ ìˆ˜ì • ì™„ë£Œ`, 'success');
            } catch (error) {
                addLog(`âŒ ê·œì¹™ ìˆ˜ì • ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function testDeleteRule() {
            if (!enhancedCRUD || !lastRuleId) {
                addLog('âš ï¸ ë¨¼ì € ê·œì¹™ì„ ìƒì„±í•´ì£¼ì„¸ìš”', 'warn');
                return;
            }

            try {
                addLog(`ğŸ“‹ ê·œì¹™ ì‚­ì œ ì‹œë„: ${lastRuleId}`, 'info');
                await enhancedCRUD.deleteRule(lastRuleId);
                addLog(`âœ… ê·œì¹™ ì‚­ì œ ì™„ë£Œ`, 'success');
                lastRuleId = null;
            } catch (error) {
                addLog(`âŒ ê·œì¹™ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function testCreateViolation() {
            if (!enhancedCRUD) {
                addLog('âš ï¸ ë¨¼ì € Realtimeì„ ì´ˆê¸°í™”í•´ì£¼ì„¸ìš”', 'warn');
                return;
            }

            const amount = parseInt(document.getElementById('violation-amount').value) || 5000;
            const memo = document.getElementById('violation-memo').value || 'í…ŒìŠ¤íŠ¸ ìœ„ë°˜';

            try {
                addLog(`âš–ï¸ ìœ„ë°˜ ê¸°ë¡ ì‹œë„: ${amount}ì›`, 'info');
                
                const violationData = {
                    rule_id: lastRuleId || 'test-rule-id',
                    violator_user_id: 'test-user-id',
                    recorded_by_user_id: 'test-user-id',
                    couple_id: document.getElementById('couple-id').value,
                    amount,
                    memo,
                    violation_date: new Date().toISOString()
                };

                const result = await enhancedCRUD.createViolation(violationData);
                addLog(`âœ… ìœ„ë°˜ ê¸°ë¡ ì™„ë£Œ`, 'success');
            } catch (error) {
                addLog(`âŒ ìœ„ë°˜ ê¸°ë¡ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function testCreateReward() {
            if (!enhancedCRUD) {
                addLog('âš ï¸ ë¨¼ì € Realtimeì„ ì´ˆê¸°í™”í•´ì£¼ì„¸ìš”', 'warn');
                return;
            }

            const title = document.getElementById('reward-title').value || 'í…ŒìŠ¤íŠ¸ ë³´ìƒ';
            const targetAmount = parseInt(document.getElementById('reward-target').value) || 50000;

            try {
                addLog(`ğŸ ë³´ìƒ ìƒì„± ì‹œë„: ${title} (${targetAmount}ì›)`, 'info');
                
                const rewardData = {
                    title,
                    description: 'í…ŒìŠ¤íŠ¸ìš© ë³´ìƒì…ë‹ˆë‹¤',
                    target_amount: targetAmount,
                    couple_id: document.getElementById('couple-id').value,
                    created_by_user_id: 'test-user-id',
                    is_achieved: false
                };

                const result = await enhancedCRUD.createReward(rewardData);
                lastRewardId = result.id;
                
                addLog(`âœ… ë³´ìƒ ìƒì„± ì™„ë£Œ: ${result.id}`, 'success');
            } catch (error) {
                addLog(`âŒ ë³´ìƒ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function testClaimReward() {
            if (!enhancedCRUD || !lastRewardId) {
                addLog('âš ï¸ ë¨¼ì € ë³´ìƒì„ ìƒì„±í•´ì£¼ì„¸ìš”', 'warn');
                return;
            }

            try {
                addLog(`ğŸ ë³´ìƒ ë‹¬ì„± ì‹œë„: ${lastRewardId}`, 'info');
                const result = await enhancedCRUD.claimReward(lastRewardId);
                addLog(`âœ… ë³´ìƒ ë‹¬ì„± ì™„ë£Œ`, 'success');
            } catch (error) {
                addLog(`âŒ ë³´ìƒ ë‹¬ì„± ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function testBroadcast() {
            if (!realtimeManager) {
                addLog('âš ï¸ ë¨¼ì € Realtimeì„ ì´ˆê¸°í™”í•´ì£¼ì„¸ìš”', 'warn');
                return;
            }

            try {
                addLog('ğŸ“¤ í…ŒìŠ¤íŠ¸ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë°œì†¡...', 'info');
                await realtimeManager.broadcastDataChange('TEST', 'test_table', {
                    message: 'í…ŒìŠ¤íŠ¸ ë¸Œë¡œë“œìºìŠ¤íŠ¸',
                    timestamp: new Date().toISOString()
                });
                addLog('âœ… ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë°œì†¡ ì™„ë£Œ', 'success');
            } catch (error) {
                addLog(`âŒ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        function checkConnection() {
            if (realtimeManager) {
                const connected = realtimeManager.isConnected;
                addLog(`ğŸ” ì—°ê²° ìƒíƒœ: ${connected ? 'ì—°ê²°ë¨' : 'ëŠì–´ì§'}`, connected ? 'success' : 'error');
                updateMainStatus(connected);
            } else {
                addLog('âš ï¸ Realtime Managerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ', 'warn');
                updateMainStatus(false);
            }
        }

        // ì´ˆê¸° ë¡œê·¸
        addLog('ğŸ¯ Enhanced Realtime í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì¤€ë¹„ ì™„ë£Œ', 'success');
        addLog('ğŸ“‹ 1. Couple ID ì…ë ¥ â†’ 2. ì—°ê²° ì‹œì‘ â†’ 3. í…ŒìŠ¤íŠ¸ ì§„í–‰', 'info');

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateMainStatus(false);
    </script>
</body>
</html>